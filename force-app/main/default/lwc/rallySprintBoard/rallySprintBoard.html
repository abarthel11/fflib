<template>
    <lightning-card title="Sprint Board" icon-name="standard:kanban">
        <div class="slds-p-around_medium slds-grid slds-wrap slds-grid_vertical-align-end">
            <div class="slds-m-right_medium slds-size_1-of-1 slds-large-size_1-of-4">
                <lightning-combobox
                    name="project"
                    label="Project"
                    placeholder="Select a project"
                    value={selectedProjectId}
                    options={projectOptions}
                    onchange={handleProjectChange}
                ></lightning-combobox>
            </div>
            <div class="slds-m-right_medium slds-size_1-of-1 slds-large-size_1-of-4">
                <lightning-combobox
                    name="sprint"
                    label="Sprint"
                    placeholder="Select a sprint"
                    value={selectedSprintId}
                    options={sprintOptions}
                    onchange={handleSprintChange}
                    disabled={disableSprintPicklist}
                ></lightning-combobox>
            </div>
            <lightning-button
                label="Refresh"
                onclick={handleRefresh}
                disabled={isRefreshDisabled}
            ></lightning-button>
        </div>
        <template if:true={showSprintDetails}>
            <div class="slds-p-horizontal_medium slds-text-body_small sprint-details">
                <span>{currentSprintLabel}</span>
                <template if:true={currentSprint}
                    ><span>
                        · {currentSprint.Start_Date__c} → {currentSprint.End_Date__c}
                    </span></template
                >
                <template if:true={currentSprint.Capacity__c}
                    ><span>· Capacity {currentSprint.Capacity__c}</span></template
                >
            </div>
        </template>
        <template if:true={showSelectionHint}>
            <p class="slds-p-horizontal_medium slds-text-color_weak">
                Choose a project and sprint to collaborate on committed work.
            </p>
        </template>
        <template if:true={showBoard}>
            <div class="kanban">
                <template for:each={columns} for:item="column">
                    <section
                        key={column.status}
                        class="kanban-column"
                        data-status={column.status}
                        ondragover={handleColumnDragOver}
                        ondrop={handleDrop}
                    >
                        <header class="column-header slds-grid slds-grid_align-spread slds-p-around_small">
                            <span>{column.status}</span>
                            <lightning-badge label={column.count}></lightning-badge>
                        </header>
                        <div class="column-body">
                            <template if:true={column.hasIssues}>
                                <template for:each={column.issues} for:item="issue">
                                    <article
                                        key={issue.Id}
                                        class="issue-card"
                                        draggable="true"
                                        data-issue-id={issue.Id}
                                        ondragstart={handleDragStart}
                                    >
                                        <div class="issue-key">{issue.Issue_Key__c}</div>
                                        <div class="issue-summary">{issue.Summary__c}</div>
                                        <div class="issue-meta">
                                            <span>{issue.Story_Points__c} pts</span>
                                            <template if:true={issue.Assignee__r}
                                                ><span>{issue.Assignee__r.Name}</span></template
                                            >
                                        </div>
                                        <template if:true={issue.Blocked__c}>
                                            <div class="issue-blocked">Blocked: {issue.BlockedReason__c}</div>
                                        </template>
                                    </article>
                                </template>
                            </template>
                            <template if:false={column.hasIssues}>
                                <p class="column-empty">No work</p>
                            </template>
                        </div>
                    </section>
                </template>
            </div>
        </template>
        <template if:true={errorMessage}>
            <p class="slds-p-horizontal_medium slds-text-color_error">{errorMessage}</p>
        </template>
        <template if:true={showSpinner}>
            <div class="spinner">
                <lightning-spinner alternative-text="Updating" size="small"></lightning-spinner>
            </div>
        </template>
    </lightning-card>
</template>